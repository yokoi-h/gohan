


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Extension &mdash; Gohan 0.0.1 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="_static/css/gohan.css" type="text/css" />
  

  
    <link rel="top" title="Gohan 0.0.1 documentation" href="index.html"/>
        <link rel="next" title="Namespace" href="namespace.html"/>
        <link rel="prev" title="Policy" href="policy.html"/> 

  
  <script src="_static/js/modernizr.min.js"></script>

</head>
<body class="wy-body-for-nav" role="document">
  <header class="gohan_header">
    <div class="logo"><a href="/"><img width="103" height="30" src="_static/img/gh-logo-color.png"></a></div>
    <div class="nav">
      <ul>
        <li><a href="https://github.com/cloudwan/gohan#getting-started">Getting started</a></li>
        <li><a href="http://cloudwan.github.io/gohan/">Docs</a></li>
        <li><a href="https://github.com/cloudwan/gohan" style="font-weight: bold">
          <span class="fa fa-github"></span>
          Github</a></li>
      </ul>
    </div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> Gohan
          

          
          </a>

          
            
            
              <div class="version">
                0.0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="config.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="schema.html">Gohan Schema</a></li>
<li class="toctree-l1"><a class="reference internal" href="commands.html">Gohan Commands</a></li>
<li class="toctree-l1"><a class="reference internal" href="api.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="database.html">Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="sync.html">Sync with backend</a></li>
<li class="toctree-l1"><a class="reference internal" href="policy.html">Policy</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="">Extension</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#javascirpt-code-block">Javascirpt Code block</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-in-exception-types">Build in exception types</a></li>
<li class="toctree-l2"><a class="reference internal" href="#build-in-javascript-functions">Build in javascript functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#event">Event</a></li>
<li class="toctree-l2"><a class="reference internal" href="#testing-javascript-extensions">Testing javascript extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#test-file-contents">Test file contents</a></li>
<li class="toctree-l3"><a class="reference internal" href="#framework-api">Framework API</a></li>
<li class="toctree-l3"><a class="reference internal" href="#example">Example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#javascript-backend">Javascript Backend</a></li>
<li class="toctree-l2"><a class="reference internal" href="#go-based-extension">Go based extension</a></li>
<li class="toctree-l2"><a class="reference internal" href="#donburi">Donburi</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#example-application">Example Application</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variables">Variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#block">Block</a></li>
<li class="toctree-l3"><a class="reference internal" href="#define">Define</a></li>
<li class="toctree-l3"><a class="reference internal" href="#event-handling">Event handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#conditionals">Conditionals</a></li>
<li class="toctree-l3"><a class="reference internal" href="#error-handling">Error handling</a></li>
<li class="toctree-l3"><a class="reference internal" href="#loops">Loops</a></li>
<li class="toctree-l3"><a class="reference internal" href="#supported-tasks">Supported tasks</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="namespace.html">Namespace</a></li>
<li class="toctree-l1"><a class="reference internal" href="benchmark.html">Benchmarking Tips</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">Gohan</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Extension</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/extension.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="extension">
<h1>Extension<a class="headerlink" href="#extension" title="Permalink to this headline">¶</a></h1>
<p>You can add additional logic using Gohan Extension.
Extensions has properties:</p>
<ul class="simple">
<li>id identity of the code</li>
<li>code contents of code</li>
<li>code_type javascript, go and donburi (DSL) are supported</li>
<li>url placement of code. currenty, <a class="reference external" href="file://">file://</a>, <a class="reference external" href="http://">http://</a> and <a class="reference external" href="https://">https://</a> schemes are supported</li>
<li>path resource path to execute code</li>
</ul>
<p>Example Code</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">code</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">console.log(Object.keys(context));</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">test</span>
  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">/v2.0/.*</span>
</pre></div>
</div>
<div class="section" id="javascirpt-code-block">
<h2>Javascirpt Code block<a class="headerlink" href="#javascirpt-code-block" title="Permalink to this headline">¶</a></h2>
<p>In the gohan extension code, you need to register context using
gohan_register_handler function.
gohan_register_handler talkes event_type (string)_ and handler (function(context)).</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">gohan_register_handler</span><span class="p">(</span><span class="s2">&quot;pre_show&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">){</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">resp</span> <span class="o">=</span> <span class="s2">&quot;pre_show event&quot;</span>
<span class="p">});</span>

<span class="nx">gohan_register_handler</span><span class="p">(</span><span class="s2">&quot;pre_update&quot;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">context</span><span class="p">){</span>
  <span class="nx">context</span><span class="p">.</span><span class="nx">resp</span> <span class="o">=</span> <span class="s2">&quot;pre_update event &quot;</span>
<span class="p">});</span>
</pre></div>
</div>
<p>context has following items</p>
<blockquote>
<div>context.schema : schema information
context.path : url path
context.role : user role
context.auth : auth_context information
context.http_request : Go HTTP request object
context.http_response : Go HTTP response writer object</div></blockquote>
</div>
<div class="section" id="build-in-exception-types">
<h2>Build in exception types<a class="headerlink" href="#build-in-exception-types" title="Permalink to this headline">¶</a></h2>
<p>In an effort to simplify writing extensions for validation Gohan supports
throwing some exceptions and handles them internally.
Gohan provides the following exception types.</p>
<ul class="simple">
<li>BaseException(msg)</li>
</ul>
<p>The base type of exception, should never be raised as itself, only extended.</p>
<ul class="simple">
<li>CustomException(msg, code)</li>
</ul>
<p>A BaseException with an additional code property. When thrown will result in
an http response with the provided code and message being written.</p>
<p>One can extend the CustomException. An example follows.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="kd">function</span> <span class="nx">ValidationException</span><span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">CustomException</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">msg</span><span class="p">,</span> <span class="mi">400</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="s2">&quot;ValidationException&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="nx">ValidationException</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="nx">CustomException</span><span class="p">.</span><span class="nx">prototype</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="build-in-javascript-functions">
<span id="gohan-built-in-functions"></span><h2>Build in javascript functions<a class="headerlink" href="#build-in-javascript-functions" title="Permalink to this headline">¶</a></h2>
<p>Gohan extension supports some build-in functions.</p>
<ul class="simple">
<li>console.log(string)</li>
</ul>
<p>Logging output</p>
<ul class="simple">
<li>gohan_http(method, url, headers, data, options)</li>
</ul>
<p>fetch data from url
method : GET | POST | PUT | DELETE
url : destination url
headers : additional headers (eg. AUTH_TOKEN)
data : post or put data
options : dictionary of options for http client
opaque : boolean - whether to parse URL or to treat it as raw</p>
<ul class="simple">
<li>gohan_db_list(transaction, schema_id, filter_object)</li>
</ul>
<p>retrive all data from database</p>
<ul class="simple">
<li>gohan_db_fetch(transaction, schema_id, id, tenant_id)</li>
</ul>
<p>get one data from db</p>
<ul>
<li><p class="first">gohan_db_query(transaction, schema_id, query_string, arguments)</p>
<p>Retrieve data with a raw query</p>
<ul class="simple">
<li>transaction: The transaction to use. When null will use a new one.</li>
<li>schema_id: The ID of the schema of which the query result populates instances</li>
<li>query_string: Raw query string such as a SQL SELECT query<ul>
<li>You can put a &#8221;?&#8221; as the placeholder of variables in your query string</li>
</ul>
</li>
<li>arguments: An array of actual values that replace place holders in query_string</li>
</ul>
</li>
<li><p class="first">gohan_db_create(transaction, schema_id, object)</p>
</li>
</ul>
<p>create data in db</p>
<ul class="simple">
<li>gohan_db_update(transaction, schema_id, object)</li>
</ul>
<p>update data in db</p>
<ul class="simple">
<li>gohan_db_state_update(transaction, schema_id, object)</li>
</ul>
<p>update data in db without informing etcd</p>
<ul class="simple">
<li>gohan_db_delete(transaction, schema_id, object)</li>
</ul>
<p>delete data in db</p>
<ul>
<li><p class="first">gohan_model_list(context, schema_id, filter)</p>
<p>Retrieve data through Gohan.</p>
<ul class="simple">
<li>context: You need to have transaction in this dictionary which you can get from given context</li>
<li>schema_id: The id of the schema of the objects we want to retrieve.</li>
<li>filter: How to filter retrieved objects. Should be a dictionary with each key being either:<ul>
<li>A property of the schema we are retrieving. Then the value has to either be a string or an array of strings.
The response is then filtered by removing all entries that do not have the value for the given key in the provided array.</li>
<li>Any of the strings &#8216;sort_key&#8217;, &#8216;sort_order&#8217;, &#8216;limit&#8217;, &#8216;offset&#8217;. These are interpreted with their values as query parameters.</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">gohan_model_fetch(context, schema_id, resource_ids)</p>
<p>Retrieve a specific resource through Gohan.</p>
<ul class="simple">
<li>context: You need to have transaction in this dictionary which you can get from given context</li>
<li>schema_id: The id of the schema of the object we want to retrieve.</li>
<li>resource_id: The id of the object we want to retrieve.</li>
<li>tenant_ids: allowed tenant id</li>
</ul>
</li>
<li><p class="first">gohan_model_create(context, schema_id, data)</p>
<p>Create an object through Gohan.</p>
<ul class="simple">
<li>context: You need to have transaction in this dictionary which you can get from given context</li>
<li>schema_id: The id of the schema of the object we want to create.</li>
<li>data: The data needed to create the object, in the form of a dictionary.</li>
</ul>
</li>
<li><p class="first">gohan_model_update(context, schema_id, resource_id, data, tenant_ids)</p>
<p>Update an object through Gohan.</p>
<ul class="simple">
<li>context: You need to have transaction in this dictionary which you can get from given context</li>
<li>schema_id: The id of the schema of the object we want to update.</li>
<li>resource_id: The id of the object we want to update.</li>
<li>data: The data needed to update the object, in the form of a dictionary.</li>
<li>tenant_ids: allowed tenant id</li>
</ul>
</li>
<li><p class="first">gohan_model_delete(context, schema_id, resource_id)</p>
<p>Delete an object through Gohan.</p>
<ul class="simple">
<li>context: You need to have transaction in this dictionary which you can get from given context</li>
<li>schema_id: The id of the schema of the object we want to delete.</li>
<li>resource_id: The id of the object we want to delete.</li>
</ul>
</li>
<li><p class="first">gohan_schemas()</p>
</li>
</ul>
<p>returns all registered schemas</p>
<ul class="simple">
<li>gohan_schema_url(schema)</li>
</ul>
<p>returns the url for the schema</p>
<ul class="simple">
<li>gohan_policies()</li>
</ul>
<p>returns all policies</p>
<ul class="simple">
<li>gohan_uuid()</li>
</ul>
<p>generate uuid v4</p>
<ul class="simple">
<li>gohan_sleep(time)</li>
</ul>
<p>sleep time (ms)</p>
<ul class="simple">
<li>gohan_execute(comand_name, args)</li>
</ul>
<p>execute shell command</p>
<ul class="simple">
<li>gohan_template(template_string, variables)</li>
</ul>
<p>apply go style template</p>
<ul class="simple">
<li>gohan_netconf_open(hostname, username)</li>
</ul>
<p>open netconf session.
(Note: you need set up ssh key configuraion
on both of gohan and target node.)
In gohan, you need to setup ssh/key_file
configuraion.</p>
<ul class="simple">
<li>gohan_netconf_exec(session, command)</li>
</ul>
<p>execute netconf command</p>
<ul class="simple">
<li>gohan_netconf_close(session)</li>
</ul>
<p>close netconf session</p>
<ul class="simple">
<li>gohan_ssh_open(hostname, username)</li>
</ul>
<p>open ssh session.
(Note: you need set up ssh key configuraion
on both of gohan and target node.)
In gohan, you need to setup ssh/key_file
configuraion.</p>
<ul class="simple">
<li>gohan_ssh_exec(session, command)</li>
</ul>
<p>execute command on ssh session</p>
<ul class="simple">
<li>gohan_ssh_close(session)</li>
</ul>
<p>close ssh session</p>
<ul class="simple">
<li>require(module)</li>
</ul>
<p>Dynamically load modules</p>
</div>
<div class="section" id="event">
<span id="id1"></span><h2>Event<a class="headerlink" href="#event" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">pre_list</p>
<p>list event before db operation</p>
<p>context.response contains response data.
You can also update response here</p>
<p>Note you can skip db operation if you set context response in here</p>
</li>
<li><p class="first">pre_list_in_transaction</p>
<p>same as pre_list but executed in the db transaction
context.transaction contains transaction object for db operation</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">post_list_in_transaction</p>
<p>same as post_list but executed in the db transaction
context.transaction contains transaction object for db operation</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">post_list</p>
<p>list event after db operation.</p>
<p>context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">pre_show</p>
<p>show event before db access</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
<p>Note you can skip db operation if you set context response in here</p>
</li>
<li><p class="first">pre_show_in_transaction</p>
<p>same as pre_show but executed in the db transaction
context.transaction contains transaction object for db operation</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">post_show_in_transaction</p>
<p>same as post_show but executed in the db transaction
context.transaction contains transaction object for db operation</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">post_show</p>
<p>show event after db operation</p>
<p>id : request id
context.response contains response data.
You can also update response here</p>
</li>
<li><p class="first">pre_create</p>
<p>executed before creation
Mainly used for validation purpose</p>
<p>context.resource contains user input data</p>
<p>Note you can skip db operation if you set context response in here</p>
</li>
<li><p class="first">pre_create_in_transaction</p>
<p>same as pre_create but executed in the db transaction
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">post_create_in_transaction</p>
<p>after creation in transaction</p>
</li>
<li><p class="first">post_create</p>
<p>after create
context.response contains response data.
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">pre_update</p>
<p>executed before update
Mainly used for validation purpose</p>
<p>context.resource contains user input data</p>
<p>Note you can skip db operation if you set context response in here</p>
</li>
<li><p class="first">pre_update_in_transaction</p>
<p>same as pre_update but executed in the db transaction
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">post_update_in_transaction</p>
<p>after creation in transaction</p>
</li>
<li><p class="first">post_update</p>
<p>after update
context.response contains response data.
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">pre_delete</p>
<p>executed before delete
Mainly used for validation purpose</p>
<p>context.id contains resource id we are trying to delete
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">pre_delete_in_transaction</p>
<p>same as pre_delete but executed in the db transaction
context.transaction contains transaction object for db operation</p>
</li>
<li><p class="first">post_delete_in_transaction</p>
<p>after creation in transaction</p>
</li>
<li><p class="first">post_delete</p>
<p>after delete</p>
</li>
<li><p class="first">pre_state_update_in_transaction</p>
<p>executed before a state update triggerred by a backend event</p>
<p>context.resource contains the resource associated with the update,
context.state contains the state changes,
context.config_version contains the current config version</p>
</li>
<li><p class="first">post_state_update_in_transaction</p>
<p>as above, but after the state update</p>
</li>
<li><p class="first">pre_monitoring_update_in_transaction</p>
<p>executed before a monitoring update triggerred by a backend event</p>
<p>context.resource contains the resource associated with the update,
context.monitoring contains the new monitoring information</p>
</li>
<li><p class="first">post_monitoring_update_in_transaction</p>
<p>as above, but after the monitoring update</p>
</li>
<li><p class="first">notification</p>
<p>executed when you receive amqp/snmp/cron notification</p>
</li>
</ul>
</div>
<div class="section" id="testing-javascript-extensions">
<h2>Testing javascript extensions<a class="headerlink" href="#testing-javascript-extensions" title="Permalink to this headline">¶</a></h2>
<p>You can test extensions using a testing tool bundled with Gohan through new
command <code class="docutils literal"><span class="pre">testextensions</span></code> (or simply <code class="docutils literal"><span class="pre">te</span></code>). Build and install Gohan, then
run <code class="docutils literal"><span class="pre">gohan</span> <span class="pre">testextensions</span> <span class="pre">&lt;paths</span> <span class="pre">to</span> <span class="pre">files/directories</span> <span class="pre">to</span> <span class="pre">test&gt;</span></code>. The
framework will walk through files and recursively through directories, matching
files named <code class="docutils literal"><span class="pre">test_.*.js</span></code> and running tests.</p>
<div class="section" id="test-file-contents">
<h3>Test file contents<a class="headerlink" href="#test-file-contents" title="Permalink to this headline">¶</a></h3>
<p>Each test file must specify schema and path for preloading extensions:</p>
<ul class="simple">
<li>var SCHEMA - path to the schema that stores extensions to be tested</li>
<li>var PATH - path for preloading extensions</li>
</ul>
<p>Additionally each file can specify:</p>
<ul class="simple">
<li>one setUp() function that will be called before each test</li>
<li>one tearDown() function that will be called after each test</li>
<li>multiple test_&lt;name&gt;() functions that will be called by the framework</li>
<li>multiple helper functions and variables, with names not starting with prefix
<code class="docutils literal"><span class="pre">test_</span></code></li>
</ul>
</div>
<div class="section" id="framework-api">
<h3>Framework API<a class="headerlink" href="#framework-api" title="Permalink to this headline">¶</a></h3>
<p>Test framework provides all built in function mentioned in subsection
describing <a class="reference internal" href="#gohan-built-in-functions">gohan built in functions</a>.</p>
<p>To avoid making HTTP requests during tests, <code class="docutils literal"><span class="pre">gohan_http</span></code> function is a mock.
You can pass values that will be returned for given arguments during subsequent
calls by calling <code class="docutils literal"><span class="pre">gohan_http.Expect(argument,</span> <span class="pre">...).Return(value)</span></code>. One call to
<code class="docutils literal"><span class="pre">gohan_http.Expect(arguments,</span> <span class="pre">...).Return(value)</span></code> provides one response of
<code class="docutils literal"><span class="pre">gohan_http</span></code> (FIFO queue). If no return value, or wrong arguments are provided
for a call then an unexpected call is assumed, which will result in test failures.</p>
<p>In addition to the abovementioned functions, the framework provides the
following API:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">Fail(format_string,</span> <span class="pre">...)</span></code> - stop execution of a single test case and
return an error</li>
<li><code class="docutils literal"><span class="pre">GohanTrigger(event_type,</span> <span class="pre">context)</span> <span class="pre">:</span> <span class="pre">&lt;new</span> <span class="pre">context&gt;</span></code> - triggers a specified
type of Gohan event<ul>
<li><code class="docutils literal"><span class="pre">event_type</span></code> - one of the event types recognized by Gohan (see
<a class="reference internal" href="#event">event</a> subsection)</li>
<li><code class="docutils literal"><span class="pre">context</span></code> - context passed to the event handler</li>
</ul>
</li>
<li><code class="docutils literal"><span class="pre">MockTransaction()</span> <span class="pre">:</span> <span class="pre">&lt;mock</span> <span class="pre">transaction&gt;</span></code> - return a mock transaction that
can be used with built-in Gohan methods. Each test is run using a separate
database that is deleted after <code class="docutils literal"><span class="pre">tearDown()</span></code>, so there is no need to
clean up the database between tests. Multiple calls to <code class="docutils literal"><span class="pre">MockTransaction()</span></code>
within a single <code class="docutils literal"><span class="pre">setUp()</span></code>, test, <code class="docutils literal"><span class="pre">tearDown()</span></code> routine when no call to
<code class="docutils literal"><span class="pre">CommitMockTransaction()</span></code> has been made will yield the same transaction.</li>
<li><code class="docutils literal"><span class="pre">CommitMockTransaction()</span></code> - commit and close the last nonclosed
transaction. After this call any calls to <code class="docutils literal"><span class="pre">MockTransaction()</span></code> return
a new transaction.</li>
<li><code class="docutils literal"><span class="pre">MockPolicy()</span> <span class="pre">:</span> <span class="pre">&lt;mock</span> <span class="pre">policy&gt;</span></code> - return a mock policy that
can be used with built-in Gohan methods.</li>
<li><code class="docutils literal"><span class="pre">MockAuthorization()</span> <span class="pre">:</span> <span class="pre">&lt;mock</span> <span class="pre">authorization&gt;</span></code> - return a mock authorization that
can be used with built-in Gohan methods.</li>
</ul>
</div>
<div class="section" id="example">
<h3>Example<a class="headerlink" href="#example" title="Permalink to this headline">¶</a></h3>
<p>A sample test may look like this:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="c1">// Schema file containing extensions to be tested</span>
<span class="kd">var</span> <span class="nx">SCHEMA</span> <span class="o">=</span> <span class="s2">&quot;../test_schema.yaml&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Sample contents of test_schema.yaml:</span>
<span class="cm"> *</span>
<span class="cm"> * extensions:</span>
<span class="cm"> * - id: network</span>
<span class="cm"> *   path: /v2.0/network.*</span>
<span class="cm"> *   url: file://./etc/examples/neutron/network.js</span>
<span class="cm"> * - id: exceptions</span>
<span class="cm"> *   path: &quot;&quot;</span>
<span class="cm"> *   url: file://./etc/examples/neutron/exceptions.js</span>
<span class="cm"> * - id: urls</span>
<span class="cm"> *   path: /gohan/v0.1/schema.*</span>
<span class="cm"> *   url: file://./etc/examples/url.js</span>
<span class="cm"> * schemas:</span>
<span class="cm"> * - description: Network</span>
<span class="cm"> *   id: network</span>
<span class="cm"> *   parent: &quot;&quot;</span>
<span class="cm"> *   plural: networks</span>
<span class="cm"> *   schema:</span>
<span class="cm"> *     properties:</span>
<span class="cm"> *       id:</span>
<span class="cm"> *         format: uuid</span>
<span class="cm"> *         permission:</span>
<span class="cm"> *         - create</span>
<span class="cm"> *         title: ID</span>
<span class="cm"> *         type: string</span>
<span class="cm"> *         unique: true</span>
<span class="cm"> *       tenant_id:</span>
<span class="cm"> *         format: uuid</span>
<span class="cm"> *         permission:</span>
<span class="cm"> *         - create</span>
<span class="cm"> *         title: Tenant id</span>
<span class="cm"> *         type: string</span>
<span class="cm"> *         unique: false</span>
<span class="cm"> *     propertiesOrder:</span>
<span class="cm"> *     - name</span>
<span class="cm"> *     - id</span>
<span class="cm"> *     - tenant_id</span>
<span class="cm"> *   singular: network</span>
<span class="cm"> *   title: Network</span>
<span class="cm"> */</span>

<span class="c1">// With the following PATH, &quot;network&quot; and &quot;exceptions&quot; extensions will be loaded</span>
<span class="kd">var</span> <span class="nx">PATH</span> <span class="o">=</span> <span class="s2">&quot;/v2.0/networks&quot;</span><span class="p">;</span>

<span class="cm">/**</span>
<span class="cm"> * Sample contents of network.js:</span>
<span class="cm"> *</span>
<span class="cm"> * // filter removes the network with the unwanted id</span>
<span class="cm"> * gohan_register_handler(&quot;post_list&quot;, function filter(context) {</span>
<span class="cm"> *     // This call will be mocked, see testNetworkListFilter below</span>
<span class="cm"> *     response = gohan_http(&quot;GET&quot;, &quot;http://whatisunwanted.com&quot;, {}, null);</span>
<span class="cm"> *</span>
<span class="cm"> *     for (var i = 0; i &lt; context.response.networks.length; i++) {</span>
<span class="cm"> *         if (context.response.networks[i].id == response.unwanted) {</span>
<span class="cm"> *             context.response.networks.splice(i, 1);</span>
<span class="cm"> *             break;</span>
<span class="cm"> *         }</span>
<span class="cm"> *     }</span>
<span class="cm"> * });</span>
<span class="cm"> */</span>

<span class="kd">var</span> <span class="nx">context</span><span class="p">;</span>
<span class="kd">var</span> <span class="nx">network</span><span class="p">;</span>

<span class="kd">function</span> <span class="nx">setUp</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">network_to_create</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;new&#39;</span><span class="p">,</span>
        <span class="s1">&#39;tenant_id&#39;</span><span class="o">:</span> <span class="s1">&#39;azerty&#39;</span>
    <span class="p">};</span>
    <span class="nx">network</span> <span class="o">=</span> <span class="nx">gohan_db_create</span><span class="p">(</span><span class="nx">MockTransaction</span><span class="p">(),</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="nx">network_to_create</span><span class="p">);</span>
    <span class="nx">context</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;schema&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">},</span>
        <span class="s1">&#39;http_request&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">},</span>
        <span class="s1">&#39;http_response&#39;</span><span class="o">:</span> <span class="p">{</span> <span class="cm">/* ... */</span> <span class="p">},</span>
        <span class="s1">&#39;path&#39;</span><span class="o">:</span> <span class="s1">&#39;/gohan/v0.1/schema&#39;</span><span class="p">,</span>
        <span class="s1">&#39;response&#39;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s1">&#39;networks&#39;</span><span class="o">:</span> <span class="p">[</span>
                <span class="nx">network</span><span class="p">,</span>
                <span class="p">{</span>
                    <span class="s1">&#39;id&#39;</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;tenant_id&#39;</span><span class="o">:</span> <span class="s1">&#39;xyz&#39;</span>
                <span class="p">}</span>
             <span class="p">]</span>
         <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">tearDown</span><span class="p">()</span> <span class="p">{</span>
  <span class="nx">gohan_db_delete</span><span class="p">(</span><span class="nx">MockTransaction</span><span class="p">(),</span> <span class="s2">&quot;network&quot;</span><span class="p">,</span> <span class="s2">&quot;new&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">testNetworkListFilter</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// First call to gohan_http will return {&#39;unwanted&#39;: &#39;foo&#39;}</span>
    <span class="nx">gohan_http</span><span class="p">.</span><span class="nx">Expect</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://whatisunwanted.com&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">null</span><span class="p">).</span><span class="nx">Return</span><span class="p">({</span><span class="s1">&#39;unwanted&#39;</span><span class="o">:</span> <span class="s1">&#39;foo&#39;</span><span class="p">});</span>
    <span class="c1">// Second call to gohan_http will return empty response</span>
    <span class="nx">gohan_http</span><span class="p">.</span><span class="nx">Expect</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;http://whatisunwanted.com&quot;</span><span class="p">,</span> <span class="p">{},</span> <span class="kc">null</span><span class="p">).</span><span class="nx">Return</span><span class="p">({});</span>
    <span class="c1">// Subsequent calls to gohan_http will fail since they are not expected</span>
    <span class="kd">var</span> <span class="nx">new_context</span> <span class="o">=</span> <span class="nx">GohanTrigger</span><span class="p">(</span><span class="s1">&#39;post_list&#39;</span><span class="p">,</span> <span class="nx">context</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">new_context</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">networks</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">Fail</span><span class="p">(</span><span class="s1">&#39;Expected 1 network but %d found.&#39;</span><span class="p">,</span> <span class="nx">new_context</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">networks</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="nx">new_context</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span> <span class="o">!=</span> <span class="nx">network</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span> <span class="p">{</span>
       <span class="nx">Fail</span><span class="p">(</span><span class="s1">&#39;Expected network with id &quot;%s&quot; but &quot;%s&quot; found.&#39;</span><span class="p">,</span> <span class="nx">network</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">new_context</span><span class="p">.</span><span class="nx">response</span><span class="p">.</span><span class="nx">networks</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">testSomethingElse</span><span class="p">()</span> <span class="p">{</span>
    <span class="cm">/* ... */</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="javascript-backend">
<h2>Javascript Backend<a class="headerlink" href="#javascript-backend" title="Permalink to this headline">¶</a></h2>
<p>Currenly, gohan is using Otto. Otto is a pure golang implementation
for javascript.
Gohan also have experimental support for v8. v8 runs js code 100-1000 times faster than Otto.</p>
<p>TODOs
- no build-in are implemented yet</p>
<p>In order to make v8 version of Gohan, you need v8worker <a class="reference external" href="https://github.com/ry/v8worker">https://github.com/ry/v8worker</a> installed in your env. (see more instruction on the repository).</p>
<p>In order to enable v8 support on extension. then set ENABLE_V8=true</p>
<div class="highlight-shell"><div class="highlight"><pre><span class="nv">ENABLE_V8</span><span class="o">=</span><span class="nb">true </span>make
</pre></div>
</div>
</div>
<div class="section" id="go-based-extension">
<h2>Go based extension<a class="headerlink" href="#go-based-extension" title="Permalink to this headline">¶</a></h2>
<p>You can extend gohan extension by native go.
You can use &#8220;go&#8221; for code_type and specify your callback id in code.
Also, you can register go struct &amp; call it from javascript.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">extensions</span><span class="p-Indicator">:</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">code</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">exampleapp_callback</span>
  <span class="l-Scalar-Plain">code_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">go</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example</span>
  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.*</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">code</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">exampleapp_callback</span>
  <span class="l-Scalar-Plain">code_type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">go</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example</span>
  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.*</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">code</span><span class="p-Indicator">:</span> <span class="p-Indicator">|</span>
    <span class="no">gohan_register_handler(&quot;pre_list&quot;, function (context){</span>
      <span class="no">var exampleModule = require(&quot;exampleapp&quot;);</span>
      <span class="no">exampleModule.HelloWorld(&quot;example app!&quot;,</span>
        <span class="no">{&quot;hobby&quot;: &quot;sleeping&quot;});</span>
    <span class="no">});</span>
  <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">example_js</span>
  <span class="l-Scalar-Plain">path</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">.*</span>
</pre></div>
</div>
<div class="highlight-go"><div class="highlight"><pre><span class="c1">//Register go callback</span>
<span class="nx">extension</span><span class="p">.</span><span class="nx">RegisterGoCallback</span><span class="p">(</span><span class="s">&quot;exampleapp_callback&quot;</span><span class="p">,</span>
      <span class="kd">func</span><span class="p">(</span><span class="nx">event</span> <span class="kt">string</span><span class="p">,</span> <span class="nx">context</span> <span class="kd">map</span><span class="p">[</span><span class="kt">string</span><span class="p">]</span><span class="kd">interface</span><span class="p">{})</span> <span class="kt">error</span> <span class="p">{</span>
              <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;callback on %s : %v&quot;</span><span class="p">,</span> <span class="nx">event</span><span class="p">,</span> <span class="nx">context</span><span class="p">)</span>
              <span class="k">return</span> <span class="kc">nil</span>
<span class="p">})</span>

<span class="nx">exampleModule</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">ExampleModule</span><span class="p">{}</span>
<span class="c1">//Register go based module for javascript</span>
<span class="nx">extension</span><span class="p">.</span><span class="nx">RegisterModule</span><span class="p">(</span><span class="s">&quot;exampleapp&quot;</span><span class="p">,</span> <span class="nx">exampleModule</span><span class="p">)</span>
</pre></div>
</div>
<p>We have exampleapp with comments in exampleapp directory.
You can also, import github.com/cloudwan/server module and
have your own RunServer method to have whole custom route written in go.</p>
</div>
<div class="section" id="donburi">
<h2>Donburi<a class="headerlink" href="#donburi" title="Permalink to this headline">¶</a></h2>
<p>Note: This function is experimental. Any APIs are subject to change.</p>
<p>Gohan support Donburi which is a yaml based DSL to support extension.
Donburi is heavyly inspired by Ansible yaml script.
The goal of Donburi is pain-less extension using YAML.
This is donburi example.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">db_tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">list</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">schema_id</span><span class="p-Indicator">:</span> <span class="s">&quot;test&quot;</span>
      <span class="l-Scalar-Plain">tenant_id</span><span class="p-Indicator">:</span> <span class="s">&quot;xxx&quot;</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">gohan_db</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fetch</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">schema_id</span><span class="p-Indicator">:</span> <span class="s">&quot;test&quot;</span>
      <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;xxx&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">resource</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;xxx&quot;</span>
      <span class="l-Scalar-Plain">schema</span><span class="p-Indicator">:</span> <span class="s">&quot;test&quot;</span>
      <span class="l-Scalar-Plain">properties</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;test&quot;</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="s">&quot;xxx&quot;</span>
<span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">message</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">world</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;hello</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">.message</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;console.log(id);&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">contrail</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">schema</span><span class="p-Indicator">:</span> <span class="s">&quot;virtual_networks&quot;</span>
      <span class="l-Scalar-Plain">properties</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="s">&quot;test&quot;</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">vm1_out</span>
</pre></div>
</div>
<p>This is the other sample.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;1</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">1&quot;</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">result</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;true&quot;</span>
    <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">when_is_working</span>
    <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">2&quot;</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">block</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">list2</span> <span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">4</span><span class="p-Indicator">,</span> <span class="nv">5</span><span class="p-Indicator">,</span> <span class="nv">6</span><span class="p-Indicator">]</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">+=</span><span class="nv"> </span><span class="s">item&quot;</span>
      <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
       <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
       <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">2</span>
       <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3</span>
    <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">when_is_working</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">+=</span><span class="nv"> </span><span class="s">item&quot;</span>
    <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;list2&quot;</span>
</pre></div>
</div>
<p>you can find an example application at etc/appts/donburi.yaml, and
example server configuraion in etc/donburi.yaml.</p>
<div class="section" id="example-application">
<h3>Example Application<a class="headerlink" href="#example-application" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>Setup contrail + openstack using vagrant</li>
</ul>
<p>See <a class="reference external" href="https://github.com/mwiget/opencontrail">https://github.com/mwiget/opencontrail</a></p>
<ul class="simple">
<li>Setup CORS (Cross-Origin Resource Sharing)  on keystone</li>
</ul>
<p>See <a class="reference external" href="https://ianunruh.com/2014/11/openstack-cors.html">https://ianunruh.com/2014/11/openstack-cors.html</a></p>
<ul class="simple">
<li>Setup notification configuration on heat</li>
</ul>
<p>/etc/heat/heat.conf</p>
<p>notification_driver=heat.openstack.common.notifier.rpc_notifier</p>
<p>restart heat-api and heat-engine</p>
<ul class="simple">
<li>Allow rabbitmq connection from your gohan host</li>
</ul>
<p>Example</p>
<div class="highlight-shell"><div class="highlight"><pre>root@ubuntu-14:/etc/rabbitmq# cat rabbitmq.config
<span class="o">[</span>
   <span class="o">{</span>rabbit, <span class="o">[</span> <span class="o">{</span>tcp_listeners, <span class="o">[{</span><span class="s2">&quot;0.0.0.0&quot;</span>, 5672<span class="o">}]}</span>,
   <span class="o">{</span>loopback_users, <span class="o">[]}</span>,
   <span class="o">{</span>log_levels,<span class="o">[{</span>connection, info<span class="o">}</span>,<span class="o">{</span>mirroring, info<span class="o">}]}</span> <span class="o">]</span>


root@ubuntu-14:/etc/rabbitmq# cat rabbitmq-env.conf

<span class="nv">NODE_IP_ADDRESS</span><span class="o">=</span>0.0.0.0
<span class="nv">NODENAME</span><span class="o">=</span>rabbit@ubuntu-14-ctrl
</pre></div>
</div>
<p>restart rabbitmq</p>
<ul class="simple">
<li>Update keystone configuraion on etc/donburi.yaml</li>
</ul>
<dl class="docutils">
<dt>keystone:</dt>
<dd>use_keystone: true
fake: false
auth_url: &#8220;<a class="reference external" href="http://172.16.25.130:5000/v3">http://172.16.25.130:5000/v3</a>&#8221;
user_name: &#8220;admin&#8221;
tenant_name: &#8220;admin&#8221;
password: &#8220;secret123&#8221;
version: v3</dd>
</dl>
<ul class="simple">
<li>Start gohan</li>
</ul>
<p>gohan server &#8211;config-file etc/donburi.yaml</p>
</div>
<div class="section" id="variables">
<h3>Variables<a class="headerlink" href="#variables" title="Permalink to this headline">¶</a></h3>
<p>You can register variables using vars task</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">list2</span> <span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">4</span><span class="p-Indicator">,</span> <span class="nv">5</span><span class="p-Indicator">,</span> <span class="nv">6</span><span class="p-Indicator">]</span>
</pre></div>
</div>
<p>you can use values in context in each value using golang
template format.
(see more details on <a class="reference external" href="http://golang.org/pkg/text/template/">http://golang.org/pkg/text/template/</a> )</p>
<p>For example, you can use context.tenant value using
&#8220;{{ .tenant }}&#8221;&#8220;</p>
<p>Note that template isn&#8217;t allowed in eval and when.</p>
</div>
<div class="section" id="block">
<h3>Block<a class="headerlink" href="#block" title="Permalink to this headline">¶</a></h3>
<p>You can have a logical grouping of tasks.
We have &#8220;block&#8221; and &#8220;resources&#8221;.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">block</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">vars</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">list2</span> <span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">4</span><span class="p-Indicator">,</span> <span class="nv">5</span><span class="p-Indicator">,</span> <span class="nv">6</span><span class="p-Indicator">]</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">+=</span><span class="nv"> </span><span class="s">item&quot;</span>
    <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">2</span>
     <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3</span>
  <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">when_is_working</span>
</pre></div>
</div>
<p>If you use reousrces block, each sub task will be executed
on reverse order on resource deletion.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">resource A</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">resource B</span> <span class="c1"># depends on resource A</span>
</pre></div>
</div>
</div>
<div class="section" id="define">
<h3>Define<a class="headerlink" href="#define" title="Permalink to this headline">¶</a></h3>
<p>You can define a function using &#8220;define&#8221; block.
last task execution result will be returned.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">define</span><span class="p-Indicator">:</span>
  <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">add</span>
  <span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;a</span><span class="nv"> </span><span class="s">+</span><span class="nv"> </span><span class="s">b&quot;</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">add</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">a</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">1</span>
    <span class="l-Scalar-Plain">b</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2</span>
  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">c</span>
</pre></div>
</div>
</div>
<div class="section" id="event-handling">
<h3>Event handling<a class="headerlink" href="#event-handling" title="Permalink to this headline">¶</a></h3>
<p>db_tasks  will be executed in main transaction
tasks will be executed outside of transaction</p>
</div>
<div class="section" id="conditionals">
<h3>Conditionals<a class="headerlink" href="#conditionals" title="Permalink to this headline">¶</a></h3>
<p>when: the statement specifed in &#8220;when&#8221; will be evaluated, and when it is true
the task will be executed
else: if evaluation result of &#8220;when&#8221; get false, else will be executed</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">2&quot;</span>
    <span class="l-Scalar-Plain">when</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">==</span><span class="nv"> </span><span class="s">2&quot;</span>
    <span class="l-Scalar-Plain">else</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">is</span><span class="nv"> </span><span class="s">not</span><span class="nv"> </span><span class="s">2&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="error-handling">
<h3>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h3>
<p>You can use rescue and always block task for error handling.
rescue will be executed only if we got execption.
always will be executed always.
retry (int) block, rescue, always will be executed &#8220;retry&#8221; count
times.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">block</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">throw &#39;error&#39;</span>
    <span class="l-Scalar-Plain">rescue</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;rescue_executed</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">true&quot;</span>
    <span class="l-Scalar-Plain">always</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;always_executed</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">true&quot;</span>
    <span class="l-Scalar-Plain">retry</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">3</span>
</pre></div>
</div>
<p>Note that last error will be stored in context.error</p>
</div>
<div class="section" id="loops">
<h3>Loops<a class="headerlink" href="#loops" title="Permalink to this headline">¶</a></h3>
<p>with_items: task will be executed for each specifed items.
if you specify string, it will be evaluated and result will be used as item.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;[4,</span><span class="nv"> </span><span class="s">5,</span><span class="nv"> </span><span class="s">6]&quot;</span>
  <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="s">&quot;list2&quot;</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">+=</span><span class="nv"> </span><span class="s">item&quot;</span>
  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">1</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">2</span>
   <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">3</span>
<span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;result</span><span class="nv"> </span><span class="s">+=</span><span class="nv"> </span><span class="s">item&quot;</span>
  <span class="l-Scalar-Plain">with_items</span><span class="p-Indicator">:</span> <span class="s">&quot;list2&quot;</span>
</pre></div>
</div>
<p>with_dict: loop over object. item will have key and value.</p>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">eval</span><span class="p-Indicator">:</span> <span class="s">&quot;context[item.key]</span><span class="nv"> </span><span class="s">=</span><span class="nv"> </span><span class="s">item.value&quot;</span>
  <span class="l-Scalar-Plain">with_dict</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">alice</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">18</span>
    <span class="l-Scalar-Plain">bob</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">21</span>
</pre></div>
</div>
</div>
<div class="section" id="supported-tasks">
<h3>Supported tasks<a class="headerlink" href="#supported-tasks" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>debug  &#8211; show debug message</li>
<li>eval &#8211; eval javasciprt</li>
<li>sleep: miliseconds  sleep certin time</li>
<li>command: execute shell command</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span>
   <span class="l-Scalar-Plain">name</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">echo</span>
   <span class="l-Scalar-Plain">args</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">test</span>
</pre></div>
</div>
<ul>
<li><p class="first">fetch &#8211; get data from db</p>
<p>schema: schema id
tenant_id: target tenant id
id: id of the resource</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">fetch</span><span class="p-Indicator">:</span>
   <span class="l-Scalar-Plain">schema</span><span class="p-Indicator">:</span> <span class="s">&quot;network&quot;</span>
   <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">response.network_id</span><span class="nv"> </span><span class="s">}}&quot;</span>
   <span class="l-Scalar-Plain">tenant_id</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
<span class="-Error"> </span><span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">network</span>
</pre></div>
</div>
<ul>
<li><p class="first">list &#8211; get data from db</p>
<p>schema: schema id
tenant_id: target tenant id
id: id of the resource</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">list</span><span class="p-Indicator">:</span>
   <span class="l-Scalar-Plain">schema</span><span class="p-Indicator">:</span> <span class="s">&quot;network&quot;</span>
   <span class="l-Scalar-Plain">tenant_id</span><span class="p-Indicator">:</span> <span class="s">&quot;&quot;</span>
<span class="-Error"> </span><span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">network</span>
</pre></div>
</div>
<ul>
<li><p class="first">contrail</p>
<p>Create contrail resources
In order to use this, you need to set correct api URL on etc/contrail/extensions/contrail_extension_config.js, and proper keystone configuraion</p>
<p>id: remote resource uuid will be saved on this specificed property in
main resource
schema: contrail resource id
allow_update: list of properties allowed to be updated
properties: remote resource properties</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">contrail</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;contrail_virtual_network&quot;</span>
    <span class="l-Scalar-Plain">schema</span><span class="p-Indicator">:</span> <span class="s">&quot;virtual-network&quot;</span>
    <span class="l-Scalar-Plain">allow_update</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
    <span class="l-Scalar-Plain">properties</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">parent_type</span><span class="p-Indicator">:</span> <span class="s">&quot;project&quot;</span>
      <span class="l-Scalar-Plain">fq_name</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">default-domain</span>
        <span class="p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">tenant_name</span><span class="nv"> </span><span class="s">}}&quot;</span>
        <span class="p-Indicator">-</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">response.id</span><span class="nv"> </span><span class="s">}}&quot;</span>
</pre></div>
</div>
<ul>
<li><p class="first">heat</p>
<p>You can crud heat stack from donburi.
This is a example</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">heat</span><span class="p-Indicator">:</span>
    <span class="l-Scalar-Plain">id</span><span class="p-Indicator">:</span> <span class="s">&quot;heat_stack_id&quot;</span>
    <span class="l-Scalar-Plain">stack_name</span><span class="p-Indicator">:</span> <span class="s">&quot;{{</span><span class="nv"> </span><span class="s">response.name</span><span class="nv"> </span><span class="s">}}&quot;</span>
    <span class="l-Scalar-Plain">template</span><span class="p-Indicator">:</span>
      <span class="l-Scalar-Plain">heat_template_version</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">2013-05-23</span>
      <span class="l-Scalar-Plain">parameters</span><span class="p-Indicator">:</span> <span class="p-Indicator">{}</span>
      <span class="l-Scalar-Plain">resources</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span>
            <span class="l-Scalar-Plain">type</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">OS::Nova::Server</span>
            <span class="l-Scalar-Plain">properties</span><span class="p-Indicator">:</span>
              <span class="l-Scalar-Plain">image</span><span class="p-Indicator">:</span> <span class="s">&quot;tinycore-in-network-nat&quot;</span>
              <span class="l-Scalar-Plain">flavor</span><span class="p-Indicator">:</span> <span class="s">&quot;m1.tiny&quot;</span>
      <span class="l-Scalar-Plain">outputs</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">server_networks</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">description</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">The networks of the deployed server</span>
          <span class="l-Scalar-Plain">value</span><span class="p-Indicator">:</span> <span class="p-Indicator">{</span> <span class="nv">get_attr</span><span class="p-Indicator">:</span> <span class="p-Indicator">[</span><span class="nv">server</span><span class="p-Indicator">,</span> <span class="nv">networks</span><span class="p-Indicator">]</span> <span class="p-Indicator">}</span>
</pre></div>
</div>
<ul>
<li><p class="first">netconf</p>
<p>You can use netconf to configure remote network devices.
Note that it is possible you get code injection attack if you
directly use user&#8217;s input.</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="l-Scalar-Plain">tasks</span><span class="p-Indicator">:</span>
  <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">block</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">netconf_open</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.response.management_ip}}&quot;</span>
          <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;admin&quot;</span>
        <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">netconf_exec</span><span class="p-Indicator">:</span>
          <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
          <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;&lt;get-config&gt;&lt;source&gt;&lt;running/&gt;&lt;/get-config&gt;&quot;</span>
        <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.output.output.Data}}&quot;</span>
    <span class="l-Scalar-Plain">always</span><span class="p-Indicator">:</span>
      <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">netconf_close</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
</pre></div>
</div>
<ul>
<li><p class="first">ssh</p>
<p>You can use ssh to configure remote hosts.
Note that it is possible you get code injection attack if you
directly use user&#8217;s input.</p>
</li>
</ul>
<div class="highlight-yaml"><div class="highlight"><pre><span class="p-Indicator">-</span> <span class="l-Scalar-Plain">block</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh_open</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">host</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.response.management_ip}}:22&quot;</span>
        <span class="l-Scalar-Plain">username</span><span class="p-Indicator">:</span> <span class="s">&quot;admin&quot;</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
      <span class="l-Scalar-Plain">rescue</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.error}}&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh_exec</span><span class="p-Indicator">:</span>
        <span class="l-Scalar-Plain">connection</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
        <span class="l-Scalar-Plain">command</span><span class="p-Indicator">:</span> <span class="s">&quot;show</span><span class="nv"> </span><span class="s">interfaces&quot;</span>
      <span class="l-Scalar-Plain">register</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">output</span>
      <span class="l-Scalar-Plain">rescue</span><span class="p-Indicator">:</span>
        <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.error}}&quot;</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">debug</span><span class="p-Indicator">:</span> <span class="s">&quot;{{.output.output}}&quot;</span>
  <span class="l-Scalar-Plain">always</span><span class="p-Indicator">:</span>
    <span class="p-Indicator">-</span> <span class="l-Scalar-Plain">ssh_close</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">session</span>
</pre></div>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="namespace.html" class="btn btn-neutral float-right" title="Namespace" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="policy.html" class="btn btn-neutral" title="Policy" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015 NTT Innovation Institute, Inc..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'0.0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="_static/jquery.js"></script>
      <script type="text/javascript" src="_static/underscore.js"></script>
      <script type="text/javascript" src="_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>